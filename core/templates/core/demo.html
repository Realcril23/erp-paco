{% extends 'base/base.html' %}

{% block principal %}
<main class="flex-1 p-8 bg-[#060608] overflow-y-auto">
    <div class="mb-10 text-center">
        <h2 class="text-5xl font-black uppercase italic text-white tracking-tighter">
            Simulador de <span class="text-neon-blue">Abonos</span>
        </h2>
        <p class="text-slate-500 mt-2 font-bold uppercase tracking-widest text-xs">Gestión de Cobro en Tiempo Real</p>
    </div>

    <div id="contenedor-clientes" class="max-w-5xl mx-auto grid gap-6">
        {% for c in clientes %}
        <div id="cliente-{{ forloop.index }}" class="bg-card-dark border border-white/5 p-8 rounded-[2rem] relative group hover:border-neon-purple/40 transition-all duration-500" 
             data-pagado="{{ c.pagado }}" data-total="{{ c.deuda_inicial }}">
            
            <div class="flex flex-col md:flex-row justify-between gap-6">
                <div class="space-y-2">
                    <span class="text-[10px] font-black px-3 py-1 bg-neon-purple/10 text-neon-purple border border-neon-purple/20 rounded-full uppercase">
                        Deuda Activa
                    </span>
                    <h3 class="text-3xl font-black text-white uppercase">{{ c.nombre }}</h3>
                    <p class="text-slate-400 font-medium flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm text-neon-blue">stat_0</span>
                        {{ c.producto }}
                    </p>
                </div>

                <div class="flex items-center">
                    <button onclick="registrarAbono('{{ forloop.index }}')" 
                            class="bg-white/5 hover:bg-neon-blue hover:text-black border border-white/10 px-6 py-3 rounded-xl font-black text-xs uppercase transition-all flex items-center gap-2 group-hover:neon-glow-blue">
                        <span class="material-symbols-outlined text-sm">payments</span>
                        Abonar $20
                    </button>
                </div>
            </div>

            <div class="mt-8 space-y-3">
                <div class="flex justify-between items-end">
                    <p class="text-xs font-black text-slate-500 uppercase">Progreso del Pago</p>
                    <p class="text-xl font-black text-white">
                        $<span id="pago-{{ forloop.index }}">{{ c.pagado }}</span> 
                        <span class="text-slate-600 text-sm">/ ${{ c.deuda_inicial }}</span>
                    </p>
                </div>
                <div class="w-full bg-white/5 h-4 rounded-full border border-white/10 p-1">
                    <div id="barra-{{ forloop.index }}" 
                         class="bg-gradient-to-r from-primary to-neon-blue h-full rounded-full transition-all duration-700 shadow-[0_0_20px_rgba(0,212,255,0.3)]" 
                         style="width: 33%"></div>
                </div>
                <div class="flex justify-between text-[10px] font-black text-slate-500 uppercase tracking-widest">
                    <span id="porcentaje-{{ forloop.index }}">33% COMPLETADO</span>
                    <span class="text-neon-blue">CUOTA MENSUAL: $20.00</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</main>

<script>
function registrarAbono(id) {
    const tarjeta = document.getElementById(`cliente-${id}`);
    const barra = document.getElementById(`barra-${id}`);
    const textoPago = document.getElementById(`pago-${id}`);
    const textoPorcentaje = document.getElementById(`porcentaje-${id}`);

    let pagado = parseFloat(tarjeta.getAttribute('data-pagado'));
    let total = parseFloat(tarjeta.getAttribute('data-total'));

    // Sumar el abono de $20
    if (pagado < total) {
        pagado += 20;
        if (pagado > total) pagado = total;

        // Actualizar datos en la tarjeta
        tarjeta.setAttribute('data-pagado', pagado);
        textoPago.innerText = pagado;

        // Calcular nuevo porcentaje
        let porcentaje = (pagado / total) * 100;
        barra.style.width = porcentaje + "%";
        textoPorcentaje.innerText = Math.round(porcentaje) + "% COMPLETADO";

        // Efecto visual de "Éxito"
        tarjeta.classList.add('border-neon-blue');
        setTimeout(() => tarjeta.classList.remove('border-neon-blue'), 500);

        // Si se canceló la deuda total, eliminar cliente con animación
        if (pagado >= total) {
            setTimeout(() => {
                tarjeta.style.transform = "scale(0.8)";
                tarjeta.style.opacity = "0";
                setTimeout(() => {
                    tarjeta.remove();
                    // Si ya no hay clientes, mostrar mensaje
                    if (document.querySelectorAll('[id^="cliente-"]').length === 0) {
                        document.getElementById('contenedor-clientes').innerHTML = 
                            '<div class="text-center py-20"><h3 class="text-2xl font-bold text-slate-500 uppercase italic">¡Todas las deudas han sido saldadas!</h3></div>';
                    }
                }, 500);
            }, 800);
        }
    }
}

// Inicializar barras al cargar la página
window.onload = function() {
    {% for c in clientes %}
        registrarAbono('{{ forloop.index }}'); // Esto es solo para que las barras se muevan al inicio
        // Nota: para la demo real, el usuario debe dar clic. 
        // He restado los 20 de la función inicial para que empiece en el estado correcto.
    {% endfor %}
};
</script>
{% endblock %}